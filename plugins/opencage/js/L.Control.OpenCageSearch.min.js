/* 
 * OpenCage Data Search Control v1.0.1 - 2014-09-11
 * Copyright (c) 2014, OpenCage Data (a Lokku brand) 
 * info@opencagedata.com 
 * http://geocoder.opencagedata.com 
 * 
 * Licensed under the BSD license. 
 * Demo: http://geocoder.opencagedata.com/code.html 
 * Source: git@github.com:lokku/leaflet-opencage-search.git 
 */
!function(a){var b;if("function"==typeof define&&define.amd)define(["leaflet"],a);else if("undefined"!=typeof module)b=require("leaflet"),module.exports=a(b);else{if("undefined"==typeof window.L)throw"Leaflet must be loaded first";a(window.L)}}(function(a){"use strict";return a.Control.OpenCageSearch=a.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search...",errorMessage:"Nothing found.",key:"",limit:5},_callbackId:0,initialize:function(b){a.Util.setOptions(this,b),this.options.geocoder||(this.options.geocoder=new a.Control.OpenCageSearch.Geocoder(this.options))},onAdd:function(b){var c,d="leaflet-control-ocd-search",e=a.DomUtil.create("div",d),f=a.DomUtil.create("div","leaflet-control-ocd-search-icon",e),g=this._form=a.DomUtil.create("form",d+"-form",e);return this._map=b,this._container=e,c=this._input=a.DomUtil.create("input"),c.type="text",a.DomEvent.addListener(c,"keydown",this._keydown,this),this._errorElement=document.createElement("div"),this._errorElement.className=d+"-form-no-error",this._errorElement.innerHTML=this.options.errorMessage,this._alts=a.DomUtil.create("ul",d+"-alternatives leaflet-control-ocd-search-alternatives-minimized"),g.appendChild(c),g.appendChild(this._errorElement),e.appendChild(this._alts),a.DomEvent.addListener(g,"submit",this._geocode,this),this.options.collapsed?"click"===this.options.expand?a.DomEvent.addListener(f,"click",function(a){0===a.button&&1===a.detail&&this._toggle()},this):(a.DomEvent.addListener(f,"mouseover",this._expand,this),a.DomEvent.addListener(f,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):this._expand(),a.DomEvent.disableClickPropagation(e),e},_geocodeResult:function(b){if(a.DomUtil.removeClass(this._container,"leaflet-control-ocd-search-spinner"),1===b.length)this._geocodeResultSelected(b[0]);else if(b.length>0){this._alts.innerHTML="",this._results=b,a.DomUtil.removeClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized");for(var c=0;c<b.length;c++)this._alts.appendChild(this._createAlt(b[c],c))}else a.DomUtil.addClass(this._errorElement,"leaflet-control-ocd-search-error")},markGeocode:function(b){return this._map.fitBounds(b.bounds),this._geocodeMarker&&this._map.removeLayer(this._geocodeMarker),this._geocodeMarker=new a.Marker(b.center).bindPopup(b.name).addTo(this._map).openPopup(),this},_geocode:function(b){return a.DomEvent.preventDefault(b),a.DomUtil.addClass(this._container,"leaflet-control-ocd-search-spinner"),this._clearResults(),this.options.geocoder.geocode(this._input.value,this._geocodeResult,this),!1},_geocodeResultSelected:function(a){this.options.collapsed?this._collapse():this._clearResults(),this.markGeocode(a)},_toggle:function(){this._container.className.indexOf("leaflet-control-ocd-search-expanded")>=0?this._collapse():this._expand()},_expand:function(){a.DomUtil.addClass(this._container,"leaflet-control-ocd-search-expanded"),this._input.select()},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-ocd-search-expanded",""),a.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),a.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_clearResults:function(){a.DomUtil.addClass(this._alts,"leaflet-control-ocd-search-alternatives-minimized"),this._selection=null,a.DomUtil.removeClass(this._errorElement,"leaflet-control-ocd-search-error")},_createAlt:function(b,c){var d=document.createElement("li");return d.innerHTML='<a href="#" data-result-index="'+c+'">'+(this.options.showResultIcons&&b.icon?'<img src="'+b.icon+'"/>':"")+b.name+"</a>",a.DomEvent.addListener(d,"click",function(){this._geocodeResultSelected(b)},this),d},_keydown:function(b){var c=this,d=function(b){c._selection&&(a.DomUtil.removeClass(c._selection.firstChild,"leaflet-control-ocd-search-selected"),c._selection=c._selection[b>0?"nextSibling":"previousSibling"]),c._selection||(c._selection=c._alts[b>0?"firstChild":"lastChild"]),c._selection&&a.DomUtil.addClass(c._selection.firstChild,"leaflet-control-ocd-search-selected")};switch(b.keyCode){case 38:d(-1),a.DomEvent.preventDefault(b);break;case 40:d(1),a.DomEvent.preventDefault(b);break;case 13:if(this._selection){var e=parseInt(this._selection.firstChild.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[e]),this._clearResults(),a.DomEvent.preventDefault(b)}}return!0}}),a.Control.openCageSearch=function(b,c){return new a.Control.OpenCageSearch(b,c)},a.Control.OpenCageSearch.callbackId=0,a.Control.OpenCageSearch.jsonp=function(b,c,d,e,f){var g="_ocd_geocoder_"+a.Control.OpenCageSearch.callbackId++;c[f||"callback"]=g,window[g]=a.Util.bind(d,e);var h=document.createElement("script");h.type="text/javascript",h.src=b+a.Util.getParamString(c),h.id=g,document.getElementsByTagName("head")[0].appendChild(h)},a.Control.OpenCageSearch.Geocoder=a.Class.extend({options:{serviceUrl:"https://api.opencagedata.com/geocode/v1/",geocodingQueryParams:{},reverseQueryParams:{},key:"",limit:5},initialize:function(b){a.Util.setOptions(this,b)},geocode:function(b,c,d){a.Control.OpenCageSearch.jsonp(this.options.serviceUrl+"json/",a.extend({q:b,limit:this.options.limit,key:this.options.key},this.options.geocodingQueryParams),function(b){for(var e=[],f=b.results.length-1;f>=0;f--)e[f]={name:b.results[f].formatted,bounds:a.latLngBounds([b.results[f].bounds.southwest.lat,b.results[f].bounds.southwest.lng],[b.results[f].bounds.northeast.lat,b.results[f].bounds.northeast.lng]),center:a.latLng(b.results[f].geometry.lat,b.results[f].geometry.lng)};c.call(d,e)},this,"jsonp")},reverse:function(a,b,c,d){this.geocode(a,c,d)}}),a.Control.OpenCageSearch.geocoder=function(b){return new a.Control.OpenCageSearch.Geocoder(b)},a.Control.OpenCageSearch});